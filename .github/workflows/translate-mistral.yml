name: Translate issues & comments using Mistral

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

jobs:
  translate_issue_append_en:
    name: Append English translation when label en is added
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      github.event.label.name == 'en'
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Translate issue FR â†’ EN using Mistral
        env:
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO: ${{ github.repository }}
        run: |
          ORIGINAL="$ISSUE_BODY"

          # PrÃ©parer la requÃªte Mistral
          REQUEST=$(jq -n --arg text "$ORIGINAL" '
            {
              model: "mistral-small-latest",
              messages: [
                {
                  role: "system",
                  content: "You are a professional Frenchâ†’English translator. Keep markdown formatting. Output ONLY the English translation."
                },
                {
                  role: "user",
                  content: $text
                }
              ]
            }
          ')

          RESPONSE=$(curl -s -X POST "https://api.mistral.ai/v1/chat/completions" \
            -H "Authorization: Bearer $MISTRAL_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$REQUEST")

          TRANSLATION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          # Construire le nouveau corps FR + Traduction EN
          NEW_BODY=$(printf "%s\n\n---\n\n## ğŸ‡¬ğŸ‡§ English translation\n\n%s" "$ORIGINAL" "$TRANSLATION")

          PAYLOAD=$(jq -n --arg body "$NEW_BODY" '{body: $body}')

          # Mise Ã  jour de l'issue (sans toucher au titre en franÃ§ais)
          curl -s -X PATCH \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER" \
            -d "$PAYLOAD"

          # Commentaire de confirmation
          COMMENT=$(jq -n \
            '{body: "ğŸ” English translation has been appended under the French original."}')

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            -d "$COMMENT"


  translate_comments_both_ways:
    name: Translate comments FR â†” EN for EN issues
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'issue_comment' &&
      github.event.action == 'created' &&
      contains(github.event.issue.labels.*.name, 'en') &&
      github.event.comment.user.type != 'Bot'
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Translate comment using Mistral
        env:
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          TEXT="$COMMENT_BODY"

          # RequÃªte pour dÃ©tection + traduction FR <-> EN
          REQUEST=$(jq -n --arg text "$TEXT" '
            {
              model: "mistral-small-latest",
              messages: [
                {
                  role: "system",
                  content: "Detect whether the text is French or English. If French, translate to English. If English, translate to French. Respond ONLY with raw JSON (no markdown, no backticks, no code blocks): {\"source\":\"fr\" or \"en\",\"target\":\"fr\" or \"en\",\"translation\":\"translated text here\"}"
                },
                {
                  role: "user",
                  content: $text
                }
              ]
            }
          ')

          RESPONSE=$(curl -s -X POST "https://api.mistral.ai/v1/chat/completions" \
            -H "Authorization: Bearer $MISTRAL_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$REQUEST")

          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          # Nettoyer le contenu pour extraire le JSON pur (enlever les backticks markdown si prÃ©sents)
          CLEAN_CONTENT=$(echo "$CONTENT" | sed 's/```json//g' | sed 's/```//g' | tr -d '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

          # VÃ©rifier que le JSON est valide avant de parser
          if echo "$CLEAN_CONTENT" | jq empty 2>/dev/null; then
            SRC=$(echo "$CLEAN_CONTENT" | jq -r '.source // "unknown"')
            TGT=$(echo "$CLEAN_CONTENT" | jq -r '.target // "unknown"')
            TRANSLATION=$(echo "$CLEAN_CONTENT" | jq -r '.translation // .text // ""')
          else
            # Fallback: utiliser le contenu brut comme traduction
            SRC="unknown"
            TGT="unknown"
            TRANSLATION="$CONTENT"
          fi

          # DÃ©terminer l'en-tÃªte adaptÃ©
          if [ "$SRC" = "fr" ] && [ "$TGT" = "en" ]; then
            HEADER="ğŸ‡«ğŸ‡· â†’ ğŸ‡¬ğŸ‡§ French â†’ English"
          elif [ "$SRC" = "en" ] && [ "$TGT" = "fr" ]; then
            HEADER="ğŸ‡¬ğŸ‡§ â†’ ğŸ‡«ğŸ‡· English â†’ FranÃ§ais"
          else
            HEADER="ğŸŒ Automatic translation"
          fi

          FINAL=$(printf "%s\n\n%s" "$HEADER" "$TRANSLATION")

          PAYLOAD=$(jq -n --arg body "$FINAL" '{body: $body}')

          # Poster le commentaire traduit
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            -d "$PAYLOAD"
