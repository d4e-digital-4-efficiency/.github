name: Translate issues & comments using Mistral

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

jobs:
  translate_issue_append_en:
    name: Append English translation when label EN is added
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      github.event.label.name == 'EN'
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Translate issue FR ‚Üí EN using Mistral
        env:
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO: ${{ github.repository }}
        run: |
          ORIGINAL="$ISSUE_BODY"

          # Pr√©parer la requ√™te Mistral
          REQUEST=$(jq -n --arg text "$ORIGINAL" '
            {
              model: "mistral-small-latest",
              messages: [
                {
                  role: "system",
                  content: "You are a professional French‚ÜíEnglish translator. Keep markdown formatting. Output ONLY the English translation."
                },
                {
                  role: "user",
                  content: $text
                }
              ]
            }
          ')

          RESPONSE=$(curl -s -X POST "https://api.mistral.ai/v1/chat/completions" \
            -H "Authorization: Bearer $MISTRAL_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$REQUEST")

          TRANSLATION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          # Construire le nouveau corps FR + Traduction EN
          NEW_BODY=$(printf "%s\n\n---\n\n## üá¨üáß English translation\n\n%s" "$ORIGINAL" "$TRANSLATION")

          PAYLOAD=$(jq -n --arg body "$NEW_BODY" '{body: $body}')

          # Mise √† jour de l'issue (sans toucher au titre en fran√ßais)
          curl -s -X PATCH \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER" \
            -d "$PAYLOAD"

          # Commentaire de confirmation
          COMMENT=$(jq -n \
            '{body: "üîÅ English translation has been appended under the French original."}')

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            -d "$COMMENT"


  translate_comments_both_ways:
    name: Translate comments FR ‚Üî EN for EN issues
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'issue_comment' &&
      github.event.action == 'created' &&
      contains(github.event.issue.labels.*.name, 'EN') &&
      github.event.comment.user.type != 'Bot'
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Translate comment using Mistral
        env:
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          TEXT="$COMMENT_BODY"

          # Requ√™te pour d√©tection + traduction FR <-> EN
          REQUEST=$(jq -n --arg text "$TEXT" '
            {
              model: "mistral-small-latest",
              messages: [
                {
                  role: "system",
                  content: "Detect whether the text is French or English. If French, translate to English. If English, translate to French. Respond only as JSON: {\"source\":\"fr/en\",\"target\":\"fr/en\",\"translation\":\"...\"}"
                },
                {
                  role: "user",
                  content: $text
                }
              ]
            }
          ')

          RESPONSE=$(curl -s -X POST "https://api.mistral.ai/v1/chat/completions" \
            -H "Authorization: Bearer $MISTRAL_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$REQUEST")

          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          SRC=$(echo "$CONTENT"        | jq -r '.source')
          TGT=$(echo "$CONTENT"        | jq -r '.target')
          TRANSLATION=$(echo "$CONTENT" | jq -r '.translation')

          # D√©terminer l'en-t√™te adapt√©
          if [ "$SRC" = "fr" ] && [ "$TGT" = "en" ]; then
            HEADER="üá´üá∑ ‚Üí üá¨üáß French ‚Üí English"
          elif [ "$SRC" = "en" ] && [ "$TGT" = "fr" ]; then
            HEADER="üá¨üáß ‚Üí üá´üá∑ English ‚Üí Fran√ßais"
          else
            HEADER="üåê Automatic translation"
          fi

          FINAL=$(printf "%s\n\n%s" "$HEADER" "$TRANSLATION")

          PAYLOAD=$(jq -n --arg body "$FINAL" '{body: $body}')

          # Poster le commentaire traduit
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            -d "$PAYLOAD"
